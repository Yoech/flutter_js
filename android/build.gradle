group 'io.abner.flutter_js'
version '1.0-SNAPSHOT'

def flutterSdkPath = {
    def properties = new Properties()
    file("local.properties").withInputStream { properties.load(it) }
    def flutterSdkPath = properties.getProperty("flutter.sdk")
    assert flutterSdkPath != null, "flutter.sdk not set in local.properties"
    return flutterSdkPath
}()

buildscript {
    ext {
        agp_version = '8.5.1'
        kotlin_version = "1.7.10"
    }
    repositories {
        google()
        mavenCentral()
        maven { url=uri('https://jitpack.io') }
        maven { url=uri('https://maven.aliyun.com/nexus/content/groups/public/') }
        maven { url=uri('https://maven.aliyun.com/repository/google') }
        maven { url=uri('https://maven.aliyun.com/repository/gradle-plugin') }
        maven { url=uri('https://maven.aliyun.com/repository/jcenter') }
        maven { url=uri('https://maven.aliyun.com/repository/central') }
        maven { url=uri('https://maven.aliyun.com/repository/public') }
        maven { url=uri('https://download.flutter.io') }
        maven { url=uri('https://storage.flutter-io.cn/download.flutter.io') }
    }

    dependencies {
        classpath("com.android.tools.build:gradle:8.5.2")
        classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version")
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
        maven { url=uri('https://jitpack.io') }
        maven { url=uri('https://maven.aliyun.com/nexus/content/groups/public/') }
        maven { url=uri('https://maven.aliyun.com/repository/google') }
        maven { url=uri('https://maven.aliyun.com/repository/gradle-plugin') }
        maven { url=uri('https://maven.aliyun.com/repository/jcenter') }
        maven { url=uri('https://maven.aliyun.com/repository/central') }
        maven { url=uri('https://maven.aliyun.com/repository/public') }
        maven { url=uri('https://download.flutter.io') }
        maven { url=uri('https://storage.flutter-io.cn/download.flutter.io') }
    }
}

apply plugin: 'com.android.library'
apply plugin: 'kotlin-android'

android {
    if (project.android.hasProperty("namespace")) {
        namespace "io.abner.flutter_js"
    }

    compileSdk 34

    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_1_8
        targetCompatibility = JavaVersion.VERSION_1_8
        encoding = "UTF-8"
    }

    kotlinOptions {
        jvmTarget = JavaVersion.VERSION_1_8.toString()
    }

    // //quickjs C build disabled for now - crashing with SEGV_MAPERR on ARM based devices
    // externalNativeBuild {
    //   // Encapsulates your CMake build configurations.
    //   cmake {
    //       // Provides a relative path to your CMake build script.
    //       path "CMakeLists.txt"
    //   }
    // }    

    defaultConfig {
        minSdk = 21
        ndk {
            abiFilters "armeabi-v7a", "arm64-v8a", "x86", "x86_64"
        }
        testInstrumentationRunner "android.support.test.runner.AndroidJUnitRunner"
    }

    dependencies {
        testImplementation("org.jetbrains.kotlin:kotlin-test")
        testImplementation("org.mockito:mockito-core:5.0.0")
        compileOnly files("$flutterSdkPath/bin/cache/artifacts/engine/android-arm/flutter.jar")
    }

    testOptions {
        unitTests.all {
            useJUnitPlatform()

            testLogging {
                events "passed", "skipped", "failed", "standardOut", "standardError"
                outputs.upToDateWhen {false}
                showStandardStreams = true
            }
        }
    }

    lintOptions {
        disable 'InvalidPackage'
        disable 'GradleDependency'
    }

    sourceSets {
        main.java.srcDirs += 'src/main/kotlin'
        main.jniLibs.srcDirs = ['jniLibs']
    }
}

dependencies {
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"
    
    // implementation using platform-channel with oasis jsbridge
    // implementation 'com.github.p7s1digital.oasis-jsbridge-android:oasis-jsbridge-quickjs:0.12.0'
    // compile group: 'org.nanohttpd', name: 'nanohttpd', version: '2.3.0'

    // for serve library from jitpack repository
    implementation "com.github.fast-development.android-js-runtimes:fastdev-jsruntimes-quickjs:0.3.5"
    implementation 'androidx.annotation:annotation-jvm:1.8.2'
    // implementation "com.github.fast-development.android-js-runtimes:fastdev-jsruntimes-jsc:0.1.3"
}
